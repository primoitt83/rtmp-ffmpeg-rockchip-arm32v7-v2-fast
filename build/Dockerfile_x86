##########################
# Build the release image.
FROM arm32v7/ubuntu:jammy

LABEL maintainer="primoitt83@gmail.com"

# Set default ports.
ENV HTTP_PORT 80
ENV HTTPS_PORT 443
ENV RTMP_PORT 1935

RUN apt update && apt install -y \
  ca-certificates \
  gettext \
  openssl \
  pcre2-utils \
  curl \
  alsa-utils

# Cleanup.
RUN apt-get clean autoclean
RUN apt-get autoremove --yes
RUN rm -rf /var/cache/* /tmp/* /var/lib/{apt,dpkg,cache,log}/

RUN mkdir -p /usr/local/nginx
RUN mkdir -p /etc/nginx
RUN mkdir -p /usr/lib/arm-linux-gnueabihf/pulseaudio

COPY ./usr_local_nginx/. /usr/local/nginx
COPY ./etc_nginx/. /etc/nginx
COPY ./ffmpeg/ffmpeg /usr/local/bin/ffmpeg
COPY ./ffmpeg/ffprobe /usr/local/bin/ffprobe
COPY ./usr_lib/. /usr/lib
COPY ./usr_lib_arm-linux-gnueabihf/. /usr/lib/arm-linux-gnueabihf
COPY ./usr_lib_arm-linux-gnueabihf_pulseaudio/. /usr/lib/arm-linux-gnueabihf/pulseaudio

## Set permissions
RUN chmod 775 /usr/local/nginx/sbin/nginx && \
    chmod 775 /usr/local/bin/ffmpeg && \
    chmod 775 /usr/local/bin/ffprobe

RUN chmod +x /usr/local/nginx/sbin/nginx && \
    chmod +x /usr/local/bin/ffmpeg && \
    chmod +x /usr/local/bin/ffprobe

# Add NGINX path, config and static files.
ENV PATH "${PATH}:/usr/local/nginx/sbin"
COPY ./nginx.conf /etc/nginx/nginx.conf.template
RUN mkdir -p /opt/data && mkdir /www
COPY ./static /www/static

## nginx custom folder permissions for user nobody
RUN mkdir /opt/data/recordings && \
    mkdir /opt/data/hls && \
    mkdir /opt/data/logs

RUN chown nobody.65534 -R /opt/data
RUN chmod 775 -R /opt/data

## entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 1935
EXPOSE 80
EXPOSE 443

ENTRYPOINT [ "/entrypoint.sh" ]


